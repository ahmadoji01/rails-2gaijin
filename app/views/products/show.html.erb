<% title @product.name %>
<% description @product.name + " Secondhand Item Page." %>
<% keywords @product.name + ", Items, Secondhand, Cheap" %>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.5.7/themes/classic/galleria.classic.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.5.7/galleria.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
<%= javascript_include_tag 'sub/owl' %>

<div class="main-content" style="width: 100%;">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-9">
                <div class="card">
                    <div class="galleria">
                        <% if @product.product_images.present? %>
                            <% @product.product_images.each do |prod_image| %>
                                <a href="<%= prod_image.image.url %>"><img src="<%= prod_image.image.url(:thumb) %>" data-title="<%= @product.name %>"></a>
                            <% end %>
                        <% else %>
                            <a href="<%= image_url("products/product-1-500.png") %>"><img src="<%= image_url("products/product-1-50.png") %>" data-title="<%= @product.name %>"></a>
                        <% end %>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <% if @product.tags.exists? %>
                                <div class="col-lg-6 col-md-12 col-sm-12">
                                    <table class="table table-hover">
                                        <tr>
                                            <td><i class="fa fa-tags"></i> Conditions</td>
                                            <td><%= @product.tags.exists? ? @product.tags.first.name : "No Information" %></td>
                                        </tr>
                                    </table>
                                </div>
                            <% end %>
                            <div class="col-lg-6 col-md-12 col-sm-12">
                                <table class="table table-hover">
                                    <tr>
                                        <td><i class="fa fa-tags"></i> Category</td>
                                        <td><%= @product.categories.exists? ? @product.categories.first.name : "No Information" %></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div class="card-title">
                            <h4>Description</h4></div>
                        <p class="card-text">
                            <%= sanitize @product.description %>
                        </p>
                        <h4 style="margin-top: 10px; margin-bottom: 5px;">Social Share</h4>
                        <%= social_share_button_tag(@product.name) %>
                    </div>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header justify-content-center">
                                <b style="font-size: 50px;">
                            <% if @product.price == 0 %>
                                <span class="currency">FREE</span>
                            <% else %> 
                                <span class="currency">&#165;</span><span class="num"><%= @product.price %></span>
                            <% end %>
                        </b>
                            </div>
                            <div class="card-body">
                                <div class="card-title">
                                    <h4><%= @product.name %></h4>
                                    <small>On <b class="product_time"><%= @product.created_at %></b></small>
                                    <% if @product.status == :sold %>
                                        <div class="alert alert-warning" style="vertical-align: middle; text-align: center" role="alert">
                                            <h5>This item is <b>Sold Out</b></h5>
                                        </div>
                                    <% end %>
                                </div>
                            </div>
                            <div class="card-footer">
                                <% if current_user != @product.user %>
                                    <% if @product.followers.include?(current_user) %>
                                        <%= link_to unfollow_products_path(id: @product.id), method: :post, class: "btn btn-lg btn-block btn-outline-primary" do %>
                                            <i class="fas fa-times-circle"></i> Unfollow This Item
                                        <% end %>
                                    <% end %>
                                <% end %>
                                <%= button_tag type: "submit", class: "btn btn-lg btn-block btn-outline-primary", data: { toggle: "modal", target: "#locationModal" } do %>
                                    <i class="fas fa-map-marked-alt"></i> See Item's Location
                                <% end %>
                                <% if user_signed_in? %>
                                    <% if current_user != @product.user %>
                                        <% if @product.status == :active %>
                                            <% if Delivery.where(:status_cd => 1, user_id: current_user.id, product_ids: @product.id).present? %>
                                                <%= link_to remove_from_delivery_delivery_path(id: @product.id), method: :post, class: "btn btn-lg btn-block btn-outline-primary" do %>
                                                    <i class="fas fa-truck"></i> Remove from Delivery
                                                <% end %>
                                            <% else %>
                                                <%= link_to add_to_delivery_delivery_path(id: @product.id), method: :post, id: "add_to_delivery_btn", data: {id: @product.id.to_s, category: @relatedcategory}, class: "btn btn-lg btn-block btn-outline-primary" do %>
                                                    <i class="fas fa-truck"></i> Add to Delivery
                                                <% end %>
                                            <% end %>
                                        <% end %>
                                    <% end %>
                                <% else %>
                                    <%= link_to new_user_session_path, class: "btn btn-lg btn-block btn-outline-primary" do %> 
                                        <i class="fas fa-truck"></i> Add to Delivery
                                    <% end %>
                                <% end %>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header mx-auto my-auto">
                                <div class="row">
                                    <div class="col-4">
                                        <%= image_tag another_user_avatar_thumb(@product.user), alt: "image", class: "rounded-circle img-thumbnail" %>
                                    </div>
                                    <div class="col-8 my-auto">
                                        <h5><%= @product.user.first_name %> <%= @product.user.last_name? ? @product.user.last_name : "" %></h5>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <% if user_signed_in? %>
                                    <% if current_user != @product.user %>
                                        <%= link_to contact_seller_rooms_path(seller_id: @product.user.id, product_id: @product.id), method: :post, class: "btn btn-lg btn-block btn-outline-primary" do %>
                                            <i class="fas fa-comments"></i> Chat with Seller
                                        <% end %> 
                                    <% elsif current_user == @product.user %>
                                        <script src="https://cdn.ckeditor.com/4.13.0/standard/ckeditor.js"></script>
                                        <%= javascript_include_tag Ckeditor.js_config_url %>
                                        <% if @product.status == :active %>
                                            <%= link_to mark_as_sold_products_path(id: @product.id), method: :post, class: "btn btn-lg btn-block btn-outline-primary" do %>
                                                <i class="fas fa-tags"></i> Mark as Sold
                                            <% end %>
                                        <% elsif @product.status == :sold %>
                                            <%= link_to mark_as_sold_products_path(id: @product.id), method: :post, class: "btn btn-lg btn-block btn-outline-primary" do %>
                                                <i class="fas fa-tags"></i> Mark as Available
                                            <% end %>
                                        <% end %>
                                        <button class="btn btn-lg btn-block btn-outline-primary" data-toggle="modal" data-target="#Modal<%= @product.id %>"><i class="fa fa-edit"></i> Edit Item Info</button>
                                        <%= link_to @product, method: :delete, data: { :"confirm-swal" => 'Are you sure?', confirm: 'Are you sure?'}, class: "btn btn-lg btn-block btn-outline-danger" do %>
                                            <i class="fa fa-trash"></i> Delete This Item
                                        <% end %>
                                        <%= render 'products/edit_modal', p: @product %>
                                    <% end %>
                                <% else %>
                                    <%= link_to new_user_session_path, class: "btn btn-lg btn-block btn-outline-primary" do %>
                                        <i class="fas fa-comments"></i> Chat with Seller
                                    <% end %>
                                <% end %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <dir class="col-lg-9 col-md-12 col-sm-12">
                <div class="card">
                    <div class="card-header">
                        <h3>Comments</h3>
                    </div>
                    <div class="card-body">
                        <% if @comments.count > 0 %>
                            <% @comments.each do |comment| %>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="d-none d-md-block col-md-2">
                                                <%= image_tag another_user_avatar(comment.user), class: "rounded-circle img-fluid w-50 mx-auto d-block" %>
                                            </div>
                                            <div class="col-md-10">
                                                <p><a href="#"><strong><%= comment.user.first_name %></strong></a>
                                                <p class="comment_time d-lg-none d-md-none text-secondary"><%= comment.created_at %></p>
                                                <span class="comment_time d-none d-lg-block d-md-block text-secondary float-right"><%= comment.created_at %></span>
                                                </p>
                                                <p><%= comment.content %></p>
                                                <% if @product.user == current_user %>
                                                    <% if current_user != comment.user %>
                                                        <%= link_to contact_seller_rooms_path(seller_id: comment.user.id), method: :post, class: "btn btn-outline-primary" do %>
                                                            <i class="fas fa-comments"></i> Chat
                                                        <% end %>
                                                    <% end %>
                                                <% end %>
                                                <% if @product.user == current_user || comment.user == current_user %>
                                                    <%= link_to comment_path(comment), method: :delete, class: "btn btn-outline-danger" do %>
                                                        <i class="fas fa-trash"></i> Delete
                                                    <% end %>
                                                <% end %>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <% end %>
                        <% else %>
                            <h5>Be the first to comment this item</h5>
                        <% end %>

                        <div class="form-group text-center">
                            <% if user_signed_in? %>
                                <%= form_for @comment do |f| %>
                                    <%= invisible_captcha %>
                                    <%= f.text_area :content, class: "form-control", placeholder: "Write Your Comment Here...", rows: "10", required: true %>
                                    <%= f.hidden_field :product_id, value: @product.id %>
                                    <%= f.button "Add Comment", type: :submit, class: "btn btn-primary float-right" %>
                                <% end %>
                            <% else %>
                                <h5><a href="<%= new_user_session_path %>">Login</a> to add your comment on this item</h5>
                            <% end %>
                        </div>
                    </div>
                </div>
            </dir>
        </div>

        <% if @userproducts.count > 0 %>
            <div class="row">
                <div class="col-lg-9 col-md-12 col-sm-12">
                    <div class="card">
                        <div class="card-header">
                            <h3>More from This User</h3>
                            <span class="d-md-none" style="position:absolute; float:right; top: 45px; margin-bottom: 5px;">
                                <%= link_to search_page_path(:user => @product.user_id, :status => 1) do %>
                                    <h4>See More <i class="fas fa-chevron-right"></i></h4>
                                <% end %>
                            </span>
                            <span class="d-none d-md-block" style="position: absolute; right: 15px; top: 20px;">
                                <%= link_to search_page_path(:user => @product.user_id, :status => 1) do %>
                                    <h2>See More <i class="fas fa-chevron-right fa-3x"></i></h2>
                                <% end %>
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="owl-carousel owl-theme" id="products-carousel-2">
                                <% if @userproducts.count > 0 %>
                                    <% @userproducts.each do |uproduct| %>
                                        <%= render 'common/rproduct_card', rproduct: uproduct %>
                                    <% end %>
                                <% end %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <% end %>

        <% if @relatedproducts.count > 0 %>
            <div class="row">
                <div class="col-lg-9 col-md-12 col-sm-12">
                    <div class="card">
                        <div class="card-header">
                            <h3>Related Items</h3>
                            <span class="d-md-none" style="position:absolute; float:right; top: 45px; margin-bottom: 5px;">
                                <%= link_to search_page_path(:relatedcategory => @relatedcategory, :status => 1) do %>
                                    <h4>See More <i class="fas fa-chevron-right"></i></h4>
                                <% end %>
                            </span>
                            <span class="d-none d-md-block" style="position: absolute; right: 15px; top: 20px;">
                                <%= link_to search_page_path(:relatedcategory => @relatedcategory, :status => 1) do %>
                                    <h2>See More <i class="fas fa-chevron-right fa-3x"></i></h2>
                                <% end %>
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="owl-carousel owl-theme" id="products-carousel">            
                                <% @relatedproducts.each do |rproduct| %>
                                    <%= render 'common/rproduct_card', rproduct: rproduct %>
                                <% end %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <% end %>
    </div>
</div>
<%= render 'products/location_modal', p: @product %>